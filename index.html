<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帕金森病問卷調查</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .bmi-result { padding: 8px; margin: 5px 0; border-radius: 4px; font-weight: bold; }
        .bmi-underweight { background-color: #e3f2fd; color: #1565c0; }
        .bmi-normal { background-color: #e8f5e8; color: #2e7d32; }
        .bmi-overweight { background-color: #fff3e0; color: #ef6c00; }
        .bmi-obese { background-color: #ffebee; color: #c62828; }
        
        .form-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .question-group {
            margin-bottom: 15px;
            padding: 15px;
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
        }
        
        .progress-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            z-index: 1000;
        }
        
        .progress-bar {
            height: 100%;
            background: #10b981;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .status-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-info { background: #3b82f6; }
        
        .nav-buttons {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .section-indicator {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e5e7eb;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .section-dot.active {
            background: #3b82f6;
            transform: scale(1.2);
        }
        
        .section-dot.completed {
            background: #10b981;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- 进度指示器 -->
    <div class="progress-indicator">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <!-- 状态消息 -->
    <div class="status-message" id="statusMessage"></div>
    
    <!-- 章节指示器 -->
    <div class="section-indicator">
        <div class="section-dot active" data-section="basic"></div>
        <div class="section-dot" data-section="medical"></div>
        <div class="section-dot" data-section="fci"></div>
        <div class="section-dot" data-section="hads"></div>
        <div class="section-dot" data-section="pdq"></div>
        <div class="section-dot" data-section="fogq"></div>
    </div>
    
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 头部 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">
                <i class="fas fa-brain mr-3 text-blue-500"></i>帕金森病問卷調查
            </h1>
            <p class="text-gray-600 mb-4">
                請填寫以下資料及問卷，所有問題均需回答。進度會自動保存，關閉網頁後可繼續填寫。
            </p>
            <div class="flex justify-center gap-4 mb-4">
                <button id="loadProgress" class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition flex items-center">
                    <i class="fas fa-download mr-2"></i>載入上次進度
                </button>
                <button id="clearProgress" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition flex items-center">
                    <i class="fas fa-trash mr-2"></i>清除進度
                </button>
                <button id="download" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition flex items-center">
                    <i class="fas fa-file-export mr-2"></i>下載數據
                </button>
            </div>
        </div>

        <form id="surveyForm" class="space-y-6">
            <!-- 基本資料 -->
            <div class="form-section" id="section-basic">
                <h2 class="text-xl font-semibold mb-4 text-blue-600 flex items-center">
                    <i class="fas fa-user-circle mr-2"></i>基本資料
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block font-medium text-gray-700 mb-2">姓名</label>
                        <input type="text" name="name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block font-medium text-gray-700 mb-2">年齡</label>
                        <input type="number" name="age" required min="0" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>

            <!-- 醫療及背景資料 -->
            <div class="form-section" id="section-medical">
                <h2 class="text-xl font-semibold mb-4 text-blue-600 flex items-center">
                    <i class="fas fa-heartbeat mr-2"></i>醫療及背景資料
                </h2>
                <div class="space-y-4">
                    <div class="question-group">
                        <label class="block font-medium text-gray-700 mb-2">得知帕金森病診斷至今多少年</label>
                        <input type="number" name="diagnosisYear" required min="0" max="60" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="question-group">
                        <label class="block font-medium text-gray-700 mb-2">讀過幾年書</label>
                        <input type="number" name="educationYears" required min="0" class="w-full p-3 border border-gray-300 rounded-lg">
                    </div>
                    
                    <div class="question-group">
                        <label class="block font-medium text-gray-700 mb-2">慣用手</label>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="dominantHand" value="右" required class="mr-2"> 右
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="dominantHand" value="左" class="mr-2"> 左
                            </label>
                        </div>
                    </div>
                    
                    <div class="question-group">
                        <label class="block font-medium text-gray-700 mb-2">是否有金屬植入物（如心臟起搏器或神經刺激器）？</label>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="implants" value="是" required class="mr-2"> 是
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="implants" value="否" class="mr-2"> 否
                            </label>
                        </div>
                    </div>
                    
                    <div class="question-group">
                        <label class="block font-medium text-gray-700 mb-2">是否使用輪椅？</label>
                        <div class="flex gap-4 flex-wrap">
                            <label class="flex items-center">
                                <input type="radio" name="wheelchair" value="不使用" required class="mr-2"> 不使用
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="wheelchair" value="偶爾用於長距離" class="mr-2"> 偶爾用於長距離
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="wheelchair" value="日常使用" class="mr-2"> 日常使用
                            </label>
                        </div>
                    </div>
                    
                    <!-- 藥物治療 -->
                    <div class="question-group">
                        <label class="block font-medium text-gray-700 mb-2">帕金森病藥物治療</label>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-gray-700 mb-1">首次服藥時間 (例：08:00)</label>
                                <input type="time" name="medFirstTime" required class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">藥效持續時間 (小時)</label>
                                <input type="number" name="medDuration" required min="0" class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 mb-1">每日服藥次數</label>
                                <input type="number" name="medFrequency" required min="0" class="w-full p-3 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    <!-- 訓練時間 -->
                    <div class="question-group">
                        <label class="block font-medium text-gray-700 mb-2">每週訓練時間偏好</label>
                        <p class="text-sm text-gray-600 mb-3">選擇不在同一天的三個1小時時段，30分鐘訓練+30分鐘準備</p>
                        <div class="space-y-3">
                            <select name="training1" required class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="" disabled selected>選擇第一時段</option>
                                <option value="星期一上午">星期一上午</option>
                                <option value="星期一下午">星期一下午</option>
                                <option value="星期二上午">星期二上午</option>
                                <option value="星期二下午">星期二下午</option>
                                <option value="星期三上午">星期三上午</option>
                                <option value="星期三下午">星期三下午</option>
                                <option value="星期四上午">星期四上午</option>
                                <option value="星期四下午">星期四下午</option>
                                <option value="星期五上午">星期五上午</option>
                                <option value="星期五下午">星期五下午</option>
                                <option value="星期六上午">星期六上午</option>
                                <option value="星期六下午">星期六下午</option>
                                <option value="星期日上午">星期日上午</option>
                                <option value="星期日下午">星期日下午</option>
                            </select>
                            <select name="training2" required class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="" disabled selected>選擇第二時段</option>
                                <option value="星期一上午">星期一上午</option>
                                <option value="星期一下午">星期一下午</option>
                                <option value="星期二上午">星期二上午</option>
                                <option value="星期二下午">星期二下午</option>
                                <option value="星期三上午">星期三上午</option>
                                <option value="星期三下午">星期三下午</option>
                                <option value="星期四上午">星期四上午</option>
                                <option value="星期四下午">星期四下午</option>
                                <option value="星期五上午">星期五上午</option>
                                <option value="星期五下午">星期五下午</option>
                                <option value="星期六上午">星期六上午</option>
                                <option value="星期六下午">星期六下午</option>
                                <option value="星期日上午">星期日上午</option>
                                <option value="星期日下午">星期日下午</option>
                            </select>
                            <select name="training3" required class="w-full p-3 border border-gray-300 rounded-lg">
                                <option value="" disabled selected>選擇第三時段</option>
                                <option value="星期一上午">星期一上午</option>
                                <option value="星期一下午">星期一下午</option>
                                <option value="星期二上午">星期二上午</option>
                                <option value="星期二下午">星期二下午</option>
                                <option value="星期三上午">星期三上午</option>
                                <option value="星期三下午">星期三下午</option>
                                <option value="星期四上午">星期四上午</option>
                                <option value="星期四下午">星期四下午</option>
                                <option value="星期五上午">星期五上午</option>
                                <option value="星期五下午">星期五下午</option>
                                <option value="星期六上午">星期六上午</option>
                                <option value="星期六下午">星期六下午</option>
                                <option value="星期日上午">星期日上午</option>
                                <option value="星期日下午">星期日下午</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FCI 問卷 -->
            <div class="form-section" id="section-fci">
                <h2 class="text-xl font-semibold mb-4 text-blue-600 flex items-center">
                    <i class="fas fa-stethoscope mr-2"></i>功能性共病指數 (FCI)
                </h2>
                <p class="text-gray-600 mb-4">請回答以下關於您健康狀況的問題，標示是否有以下共病（是/否）。所有問題均需回答。</p>
                
                <div class="space-y-4">
                    <!-- FCI 問題會由 JavaScript 動態生成 -->
                </div>
            </div>

            <!-- HADS 問卷 -->
            <div class="form-section" id="section-hads">
                <h2 class="text-xl font-semibold mb-4 text-blue-600 flex items-center">
                    <i class="fas fa-brain mr-2"></i>醫院焦慮及抑鬱量表 (HADS)
                </h2>
                <p class="text-gray-600 mb-4">請閱讀下列每題，並選擇最接近你過去一星期的情緒狀況的選項。</p>
                
                <div class="space-y-6">
                    <!-- HADS 問題會由 JavaScript 動態生成 -->
                </div>
            </div>

            <!-- PDQ-39 問卷 -->
            <div class="form-section" id="section-pdq">
                <h2 class="text-xl font-semibold mb-4 text-blue-600 flex items-center">
                    <i class="fas fa-chart-line mr-2"></i>帕金森病生活質量問卷 (PDQ-39)
                </h2>
                <p class="text-gray-600 mb-4">在過去一個月中，帕金森病對你在下列各項的日常生活影響有多少：</p>
                
                <div class="space-y-4">
                    <!-- PDQ-39 問題會由 JavaScript 動態生成 -->
                </div>
            </div>

            <!-- FOGQ 問卷 -->
            <div class="form-section" id="section-fogq">
                <h2 class="text-xl font-semibold mb-4 text-blue-600 flex items-center">
                    <i class="fas fa-walking mr-2"></i>步態凍結問卷 (FOGQ)
                </h2>
                <p class="text-gray-600 mb-4">請觀看以下影片以了解步態凍結的相關信息，然後回答問題。</p>
                
                <div class="mb-6">
                    <div id="loading" class="text-center mb-4 text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>影片載入中，請稍候...
                    </div>
                    <iframe id="fogqVideo" width="100%" height="400" src="https://www.youtube.com/embed/TSoD3ecvzu4?rel=0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen style="display: none;"></iframe>
                </div>
                
                <div class="space-y-4">
                    <!-- FOGQ 問題會由 JavaScript 動態生成 -->
                </div>
            </div>

            <!-- 提交按鈕 -->
            <div class="text-center mt-8">
                <button type="submit" class="bg-blue-500 text-white px-8 py-3 rounded-lg hover:bg-blue-600 transition text-lg font-semibold flex items-center justify-center mx-auto">
                    <i class="fas fa-paper-plane mr-2"></i>提交問卷
                </button>
            </div>
        </form>
    </div>

    <!-- 導航按鈕 -->
    <div class="nav-buttons">
        <button id="prevSection" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition hidden">
            <i class="fas fa-arrow-left mr-2"></i>上一部分
        </button>
        <button id="nextSection" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">
            下一部分<i class="fas fa-arrow-right ml-2"></i>
        </button>
    </div>

    <script>
        // 配置
        const CONFIG = {
            autoSave: true,
            saveInterval: 2000, // 2秒自動保存
            enableGoogleSheets: false, // 關閉 Google Sheets 提交
            currentSessionId: 'survey_' + Date.now()
        };

        // DOM 元素
        const form = document.getElementById('surveyForm');
        const downloadBtn = document.getElementById('download');
        const loadProgressBtn = document.getElementById('loadProgress');
        const clearProgressBtn = document.getElementById('clearProgress');
        const prevSectionBtn = document.getElementById('prevSection');
        const nextSectionBtn = document.getElementById('nextSection');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const sectionDots = document.querySelectorAll('.section-dot');

        // 狀態管理
        let currentSection = 0;
        const sections = ['basic', 'medical', 'fci', 'hads', 'pdq', 'fogq'];
        let formData = {};
        let autoSaveTimer = null;

        // 問卷問題定義
        const FCI_QUESTIONS = [
            "關節炎（類風濕性關節炎或骨關節炎）",
            "骨質疏鬆症",
            "哮喘",
            "慢性阻塞性肺病、急性呼吸窘迫綜合症或肺氣腫",
            "心絞痛",
            "充血性心力衰竭（或心臟病）",
            "心肌梗塞（心臟病發）",
            "神經退行性疾病（如帕金森病或認知症）*",
            "週邊血管疾病",
            "糖尿病（第一型或第二型）",
            "上消化道疾病（潰瘍、橫膈膜疝氣或胃食道逆流）",
            "聽力障礙（即使使用助聽器仍嚴重聽力困難）",
            "退行性椎間盤疾病（背部疾病、脊柱狹窄或嚴重慢性背痛）",
            "肥胖（BMI > 30）"
        ];

        const HADS_QUESTIONS = [
            { question: "我感到神經緊張", options: ["大部份時候感到 (3)", "很多時候感到 (2)", "有時候、間中感到 (1)", "完全不感到 (0)"] },
            { question: "我依然享受我以前享受的事物", options: ["肯定和以前一樣 (0)", "有點不及以前 (1)", "只及以前少許 (2)", "和以前差得極遠 (3)"] },
            { question: "我有一種驚恐，好像有些可怕的事情會發生", options: ["很肯定有，而且相當厲害 (3)", "有，但不太厲害 (2)", "有少許，但不令我擔心 (1)", "完全沒有 (0)"] },
            { question: "我能看到事物有趣的一面並且會心微笑", options: ["和以前一樣 (0)", "有點不如以前 (1)", "肯定不如以前 (2)", "完全不能 (3)"] },
            { question: "煩惱的念頭在我腦海中浮現", options: ["絕大部份時候 (3)", "很多時候 (2)", "有時候，但不太常 (1)", "只是間中 (0)"] },
            { question: "我感到高興", options: ["完全不感到 (3)", "不時常感到 (2)", "有時候感到 (1)", "大部份時候感到 (0)"] },
            { question: "我能安坐並感到鬆弛", options: ["肯定能夠 (0)", "通常能夠 (1)", "不時常能夠 (2)", "完全不能 (3)"] },
            { question: "我感到缺乏衝勁，整個人都慢下來", options: ["差不多全部時候 (3)", "非常多時候 (2)", "有時候 (1)", "完全沒有 (0)"] },
            { question: "我有一種忐忑不安的驚恐", options: ["完全沒有 (0)", "間中有 (1)", "相當多時候有 (2)", "很常有 (3)"] },
            { question: "我對自己的儀容已失去興趣", options: ["肯定失去 (3)", "比我應該關心的少 (2)", "可能比我以前關心的少 (1)", "我像以前一樣關心 (0)"] },
            { question: "我感到不能安靜，像要不停地走動", options: ["很強烈 (3)", "相當強烈 (2)", "不太強烈 (1)", "完全沒有 (0)"] },
            { question: "我對未來的事抱有熱切期望", options: ["和以前一樣 (0)", "較為不如以前 (1)", "肯定不如以前 (2)", "絕無僅有 (3)"] },
            { question: "我突然感到驚惶失措", options: ["非常多時候 (3)", "相當多時候 (2)", "不太多時候 (1)", "完全沒有 (0)"] },
            { question: "我能享受喜歡的書、電台或電視節目", options: ["經常能夠 (0)", "有時候能夠 (1)", "不常能夠 (2)", "絕少能夠 (3)"] }
        ];

        const PDQ_QUESTIONS = [
            "做從前喜歡的消遣活動時有困難",
            "做家居工作 (如煮飯、家務) 時有困難",
            "購物後攜帶所購物品時有困難",
            "步行半哩 (大約800米) 時有困難",
            "步行一百碼 (大約90米) 時有困難",
            "在家中自由走動時有困難",
            "在公眾場所內走動時有困難",
            "外出時需要別人陪伴",
            "在公眾場所內很怕或很擔心會跌倒",
            "留在家中的時間比起自己希望的為長",
            "替自己沐浴時有困難",
            "替自己穿衣時有困難",
            "替自己扣鈕或縛鞋帶時有困難",
            "要清楚地書寫時有困難",
            "用刀切食物時有困難",
            "拿起水杯要保持不倒瀉水會有困難",
            "感到抑鬱",
            "感到孤單和被隔離",
            "感覺想哭或流淚",
            "感到憤怒或苦澀",
            "感到焦慮",
            "替自己的將來感到憂慮",
            "不想讓他人知道你有帕金森病",
            "盡量避免在公眾場合飲食",
            "因自己患有帕金森病，在公眾場合會感到尷尬",
            "為別人對自己患病所作出的反應而感到擔心",
            "親密的人際關係因患病而出現問題",
            "缺乏配偶或伴侶所給予的支持 (如無配偶或伴侶，請選「從來沒有」)",
            "缺乏家庭或摯友所給予的支持",
            "在日間無故地睡著",
            "集中精神時有困難 (如正在閱讀或觀看電視)",
            "覺得自己記憶力差",
            "有發惡夢或出現幻覺的情況",
            "說話時有困難",
            "覺得自己不能與別人正常地溝通",
            "覺得被別人忽視",
            "肌肉有痛性抽筋",
            "關節或身體部分覺得疼痛",
            "對外界環境的冷或熱感到很不舒服 (例：進出空氣調節房間)"
        ];

        const FOGQ_QUESTIONS = [
            { question: "最近一周，在您狀態最差的時候走路", options: ["正常 (0)", "基本正常 - 稍微緩慢 (1)", "緩慢但是完全獨立 (2)", "需要幫助或是助行器 (3)", "不能行走 (4)"] },
            { question: "最近一周，您的步態困難影響日常活動和獨立做事嗎？", options: ["一點兒也不 (0)", "輕度影響 (1)", "中度影響 (2)", "嚴重影響 (3)", "不能行走 (4)"] },
            { question: "走路過程中、轉身或剛開始走路時，有沒有雙腳黏住地面的感覺（凍結）？", options: ["從來沒有 (0)", "極少 - 約1次/月 (1)", "較少 - 約1次/周 (2)", "經常 - 約1次/天 (3)", "總是 - 只要走路就有 (4)"] },
            { question: "最近一周，最長的一次凍結是多長時間？", options: ["從來沒有 (0)", "持續1-2秒 (1)", "持續3-10秒 (2)", "持續11-30秒 (3)", "超過30秒不能走路 (4)"] },
            { question: "最近一周，您出現一次典型的啟動猶豫是多長時間（開始第一步時凍結）？", options: ["無 (0)", "超過1秒開始行走 (1)", "超過3秒開始行走 (2)", "超過10秒開始行走 (3)", "超過30秒開始行走 (4)"] },
            { question: "最近一周，您出現一次典型的轉身猶豫是多長時間（轉身時凍結）？", options: ["無 (0)", "持續1-2秒 (1)", "持續3-10秒 (2)", "持續11-30秒 (3)", "持續超過30秒 (4)"] }
        ];

        // 初始化函數
        function init() {
            generateQuestionForms();
            setupEventListeners();
            loadProgress();
            updateProgressBar();
            updateNavigation();
            
            // 設置影片加載監聽
            const videoIframe = document.getElementById('fogqVideo');
            const loadingDiv = document.getElementById('loading');
            if (videoIframe && loadingDiv) {
                videoIframe.addEventListener('load', () => {
                    loadingDiv.style.display = 'none';
                    videoIframe.style.display = 'block';
                });
            }
        }

        // 生成動態問題表單
        function generateQuestionForms() {
            generateFCIQuestions();
            generateHADSQuestions();
            generatePDQQuestions();
            generateFOGQQuestions();
        }

        function generateFCIQuestions() {
            const container = document.querySelector('#section-fci .space-y-4');
            FCI_QUESTIONS.forEach((question, index) => {
                const num = index + 1;
                const html = `
                    <div class="question-group">
                        <label class="block font-medium text-gray-700 mb-2">${num}. ${question}</label>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="fci${num}" value="是" required class="mr-2"> 是
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="fci${num}" value="否" class="mr-2"> 否
                            </label>
                        </div>
                        ${num === 8 ? '<p class="text-sm text-gray-500 mt-2">*註：本研究針對帕金森病患者，請如實回答是否有其他神經退行性疾病（如認知症）。</p>' : ''}
                        ${num === 14 ? `
                            <div class="mt-3 grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 mb-1">身高 (厘米)</label>
                                    <input type="number" name="fci18_height" step="0.01" required min="0" class="w-full p-2 border border-gray-300 rounded">
                                </div>
                                <div>
                                    <label class="block text-gray-700 mb-1">體重 (公斤)</label>
                                    <input type="number" name="fci18_weight" step="0.1" required min="0" class="w-full p-2 border border-gray-300 rounded">
                                </div>
                            </div>
                            <div id="bmiResult" class="mt-2 p-2 rounded text-sm font-medium hidden"></div>
                        ` : ''}
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function generateHADSQuestions() {
            const container = document.querySelector('#section-hads .space-y-6');
            HADS_QUESTIONS.forEach((item, index) => {
                const num = index + 1;
                const html = `
                    <div class="question-group">
                        <p class="font-medium text-gray-800 mb-3">${num}. ${item.question}</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${item.options.map((option, optIndex) => `
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="radio" name="hads${num}" value="${optIndex}" required class="mr-3">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function generatePDQQuestions() {
            const container = document.querySelector('#section-pdq .space-y-4');
            PDQ_QUESTIONS.forEach((question, index) => {
                const num = index + 1;
                const html = `
                    <div class="question-group">
                        <p class="font-medium text-gray-800 mb-3">${num}. ${question}</p>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                            <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="radio" name="pdq${num}" value="0" required class="mr-2"> 從來沒有 (0)
                            </label>
                            <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="radio" name="pdq${num}" value="1" class="mr-2"> 偶然 (1)
                            </label>
                            <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="radio" name="pdq${num}" value="2" class="mr-2"> 有時候 (2)
                            </label>
                            <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="radio" name="pdq${num}" value="3" class="mr-2"> 經常 (3)
                            </label>
                            <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                <input type="radio" name="pdq${num}" value="4" class="mr-2"> 完全做不到或所有時候 (4)
                            </label>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function generateFOGQQuestions() {
            const container = document.querySelector('#section-fogq .space-y-4');
            FOGQ_QUESTIONS.forEach((item, index) => {
                const num = index + 1;
                const html = `
                    <div class="question-group">
                        <p class="font-medium text-gray-800 mb-3">${num}. ${item.question}</p>
                        <div class="grid grid-cols-1 gap-2">
                            ${item.options.map((option, optIndex) => `
                                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                                    <input type="radio" name="fogq${num}" value="${optIndex}" required class="mr-3">
                                    ${option}
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        // 事件監聽器設置
        function setupEventListeners() {
            // 表單輸入自動保存
            if (CONFIG.autoSave) {
                form.addEventListener('input', debounce(saveProgress, CONFIG.saveInterval));
                form.addEventListener('change', debounce(saveProgress, CONFIG.saveInterval));
            }

            // BMI 計算
            const heightInput = form.querySelector('[name="fci18_height"]');
            const weightInput = form.querySelector('[name="fci18_weight"]');
            if (heightInput && weightInput) {
                heightInput.addEventListener('input', updateBMI);
                weightInput.addEventListener('input', updateBMI);
            }

            // 按鈕事件
            loadProgressBtn.addEventListener('click', loadProgress);
            clearProgressBtn.addEventListener('click', clearProgress);
            downloadBtn.addEventListener('click', downloadData);
            prevSectionBtn.addEventListener('click', goToPreviousSection);
            nextSectionBtn.addEventListener('click', goToNextSection);
            form.addEventListener('submit', handleSubmit);

            // 章節導航點擊
            sectionDots.forEach((dot, index) => {
                dot.addEventListener('click', () => goToSection(index));
            });

            // 滾動檢測當前章節
            window.addEventListener('scroll', updateCurrentSection);
        }

        // 工具函數
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status-message status-${type}`;
            statusMessage.style.opacity = '1';
            
            setTimeout(() => {
                statusMessage.style.opacity = '0';
            }, 3000);
        }

        // 進度管理
        function saveProgress() {
            const formData = new FormData(form);
            const progress = {};
            for (const [key, value] of formData.entries()) {
                progress[key] = value;
            }
            
            // 添加會話ID和時間戳
            progress.sessionId = CONFIG.currentSessionId;
            progress.lastSaved = new Date().toISOString();
            
            localStorage.setItem('surveyProgress', JSON.stringify(progress));
            updateProgressBar();
            updateSectionCompletion();
        }

        function loadProgress() {
            let progress = null;
            try {
                progress = JSON.parse(localStorage.getItem('surveyProgress'));
            } catch (e) {
                console.error('載入進度失敗:', e);
            }
            
            if (!progress) {
                showStatus('無保存的進度！', 'error');
                return;
            }
            
            // 只加載當前會話的進度
            if (progress.sessionId !== CONFIG.currentSessionId) {
                showStatus('檢測到其他會話的進度，已清除', 'info');
                clearProgress();
                return;
            }
            
            for (const [key, value] of Object.entries(progress)) {
                if (key === 'sessionId' || key === 'lastSaved') continue;
                
                const elements = form.querySelectorAll(`[name="${key}"]`);
                if (elements.length === 0) continue;
                
                if (elements[0].type === 'radio' || elements[0].type === 'checkbox') {
                    const target = form.querySelector(`[name="${key}"][value="${value}"]`);
                    if (target) target.checked = true;
                } else {
                    elements[0].value = value;
                }
            }
            
            updateBMI();
            updateProgressBar();
            updateSectionCompletion();
            showStatus('已載入上次進度！', 'success');
        }

        function clearProgress() {
            localStorage.removeItem('surveyProgress');
            localStorage.removeItem('surveyData');
            form.reset();
            updateProgressBar();
            updateSectionCompletion();
            CONFIG.currentSessionId = 'survey_' + Date.now();
            showStatus('進度已清除！', 'success');
        }

        // BMI 計算
        function updateBMI() {
            const heightInput = form.querySelector('[name="fci18_height"]');
            const weightInput = form.querySelector('[name="fci18_weight"]');
            const bmiResult = document.getElementById('bmiResult');
            const obesityYes = form.querySelector('[name="fci14"][value="是"]');
            const obesityNo = form.querySelector('[name="fci14"][value="否"]');
            
            if (!heightInput || !weightInput || !bmiResult) return;
            
            const h = parseFloat(heightInput.value || 0);
            const w = parseFloat(weightInput.value || 0);
            
            if (h <= 0 || w <= 0) {
                bmiResult.style.display = 'none';
                return;
            }
            
            const bmi = w / Math.pow(h / 100, 2);
            const rounded = bmi.toFixed(1);
            let category = '', categoryClass = '';
            
            if (bmi < 18.5) { category = '體重過輕'; categoryClass = 'bmi-underweight'; }
            else if (bmi < 24) { category = '正常範圍'; categoryClass = 'bmi-normal'; }
            else if (bmi < 27) { category = '過重'; categoryClass = 'bmi-overweight'; }
            else if (bmi < 30) { category = '輕度肥胖'; categoryClass = 'bmi-overweight'; }
            else if (bmi < 35) { category = '中度肥胖'; categoryClass = 'bmi-obese'; }
            else { category = '重度肥胖'; categoryClass = 'bmi-obese'; }
            
            bmiResult.textContent = `BMI: ${rounded} - ${category}`;
            bmiResult.className = `bmi-result ${categoryClass}`;
            bmiResult.style.display = 'block';
            
            if (obesityYes && obesityNo) {
                if (bmi > 30) {
                    obesityYes.checked = true;
                } else {
                    obesityNo.checked = true;
                }
            }
        }

        // 進度條更新
        function updateProgressBar() {
            const formData = new FormData(form);
            let filledFields = 0;
            let totalFields = 0;
            
            // 計算表單字段
            const inputs = form.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.required || input.value) {
                    totalFields++;
                    if (input.value && input.type !== 'radio' && input.type !== 'checkbox') {
                        filledFields++;
                    } else if ((input.type === 'radio' || input.type === 'checkbox') && input.checked) {
                        filledFields++;
                    }
                }
            });
            
            const progress = totalFields > 0 ? (filledFields / totalFields) * 100 : 0;
            progressBar.style.width = `${progress}%`;
        }

        // 章節完成狀態
        function updateSectionCompletion() {
            sectionDots.forEach((dot, index) => {
                const sectionId = sections[index];
                const sectionElement = document.getElementById(`section-${sectionId}`);
                const inputs = sectionElement.querySelectorAll('input[required], select[required]');
                let completed = true;
                
                inputs.forEach(input => {
                    if (input.type === 'radio') {
                        const name = input.name;
                        const checked = sectionElement.querySelector(`input[name="${name}"]:checked`);
                        if (!checked) completed = false;
                    } else if (!input.value) {
                        completed = false;
                    }
                });
                
                dot.classList.toggle('completed', completed);
            });
        }

        // 導航功能
        function goToSection(index) {
            if (index < 0 || index >= sections.length) return;
            
            currentSection = index;
            const sectionId = sections[index];
            const element = document.getElementById(`section-${sectionId}`);
            
            element.scrollIntoView({ behavior: 'smooth' });
            updateNavigation();
            updateSectionDots();
        }

        function goToPreviousSection() {
            goToSection(currentSection - 1);
        }

        function goToNextSection() {
            goToSection(currentSection + 1);
        }

        function updateNavigation() {
            prevSectionBtn.classList.toggle('hidden', currentSection === 0);
            nextSectionBtn.classList.toggle('hidden', currentSection === sections.length - 1);
            
            if (currentSection === sections.length - 1) {
                nextSectionBtn.innerHTML = '提交問卷<i class="fas fa-paper-plane ml-2"></i>';
                nextSectionBtn.type = 'submit';
            } else {
                nextSectionBtn.innerHTML = '下一部分<i class="fas fa-arrow-right ml-2"></i>';
                nextSectionBtn.type = 'button';
            }
        }

        function updateSectionDots() {
            sectionDots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentSection);
            });
        }

        function updateCurrentSection() {
            const scrollPosition = window.scrollY + 100;
            
            for (let i = sections.length - 1; i >= 0; i--) {
                const section = document.getElementById(`section-${sections[i]}`);
                if (section.offsetTop <= scrollPosition) {
                    if (currentSection !== i) {
                        currentSection = i;
                        updateNavigation();
                        updateSectionDots();
                    }
                    break;
                }
            }
        }

        // 數據處理
        function buildResponseData() {
            const formData = new FormData(form);
            const data = {
                timestamp: new Date().toISOString(),
                sessionId: CONFIG.currentSessionId,
                type: 'survey'
            };
            
            // 基本資料
            data.name = formData.get('name');
            data.age = formData.get('age');
            data.diagnosisYear = formData.get('diagnosisYear');
            data.educationYears = formData.get('educationYears');
            data.dominantHand = formData.get('dominantHand');
            data.implants = formData.get('implants');
            data.wheelchair = formData.get('wheelchair');
            data.medFirstTime = formData.get('medFirstTime');
            data.medDuration = formData.get('medDuration');
            data.medFrequency = formData.get('medFrequency');
            data.training1 = formData.get('training1');
            data.training2 = formData.get('training2');
            data.training3 = formData.get('training3');
            
            // FCI 數據
            for (let i = 1; i <= 14; i++) {
                data[`fci${i}`] = formData.get(`fci${i}`);
            }
            data.fci18_height = formData.get('fci18_height');
            data.fci18_weight = formData.get('fci18_weight');
            
            // 計算 FCI 總分
            data.fciTotal = 0;
            for (let i = 1; i <= 14; i++) {
                if (formData.get(`fci${i}`) === '是') data.fciTotal++;
            }
            
            // HADS 數據
            let hadsAnxiety = 0, hadsDepression = 0;
            const anxietyItems = [1, 3, 5, 7, 9, 11, 13];
            const depressionItems = [2, 4, 6, 8, 10, 12, 14];
            
            for (let i = 1; i <= 14; i++) {
                const value = parseInt(formData.get(`hads${i}`) || 0);
                data[`hads${i}`] = value;
                
                if (anxietyItems.includes(i)) hadsAnxiety += value;
                if (depressionItems.includes(i)) hadsDepression += value;
            }
            
            data.hadsAnxiety = hadsAnxiety;
            data.hadsDepression = hadsDepression;
            
            // PDQ-39 數據
            let pdqTotal = 0;
            for (let i = 1; i <= 39; i++) {
                const value = parseInt(formData.get(`pdq${i}`) || 0);
                data[`pdq${i}`] = value;
                pdqTotal += value;
            }
            data.pdqTotal = pdqTotal;
            
            // FOGQ 數據
            let fogqTotal = 0;
            for (let i = 1; i <= 6; i++) {
                const value = parseInt(formData.get(`fogq${i}`) || 0);
                data[`fogq${i}`] = value;
                fogqTotal += value;
            }
            data.fogqTotal = fogqTotal;
            
            return data;
        }

        // 提交處理
        async function handleSubmit(e) {
            e.preventDefault();
            
            const responseData = buildResponseData();
            
            // 保存到本地存儲
            try {
                // 獲取現有數據或初始化
                let allData = JSON.parse(localStorage.getItem('surveyData') || '[]');
                
                // 移除同一會話的舊數據（避免重複）
                allData = allData.filter(item => item.sessionId !== CONFIG.currentSessionId);
                
                // 添加新數據
                allData.push(responseData);
                
                // 保存回本地存儲
                localStorage.setItem('surveyData', JSON.stringify(allData));
                
                // 清除進度但保留數據
                localStorage.removeItem('surveyProgress');
                
                showStatus('問卷提交成功！數據已保存。', 'success');
                
                // 提供下載
                setTimeout(() => {
                    downloadData();
                }, 1000);
                
            } catch (error) {
                console.error('保存失敗:', error);
                showStatus('保存失敗，請手動下載數據！', 'error');
            }
        }

        // 下載功能
        function downloadData() {
            let allData;
            try {
                allData = JSON.parse(localStorage.getItem('surveyData') || '[]');
            } catch {
                allData = [];
            }
            
            if (allData.length === 0) {
                showStatus('暫無數據可下載！', 'error');
                return;
            }
            
            // 創建 JSON 文件
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            // 創建下載鏈接
            const a = document.createElement('a');
            a.href = url;
            a.download = `parkinson_survey_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('數據下載成功！', 'success');
        }

        // 初始化應用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
